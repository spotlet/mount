#!/bin/bash

set -o pipefail

## environment
export PREFIX="${PREFIX:-/usr/local}"
export SPOTLET="${SPOTLET:-${PREFIX}/spotlet}"
export SERVICE="${SERVICE:-${SPOTLET}/service}"
export APP="${APP:-${SERVICE}/app}"

## update path
export PATH="${SPOTLET}/bin:${SERVICE}/bin:${PATH}"

## return codes
export ERROR=10
export NEEDS_COMPILE=11

## setup bin in path
setup () {
  export PATH="${SPOTLET}/bin:${PATH}"

  {
    pushd . > /dev/null 2>&1
    cd $(dirname ${BASH_SOURCE[0]})
    install $(ls) ${PREFIX}/bin
    popd > /dev/null 2>&1
  } > /dev/null 2>&1

  mkdir -p ${SERVICE} > /dev/null 2>&1
  mkdir -p ${APP} > /dev/null 2>&1

  return $?
}

## ensure file exists
ensure () {
  local arg="${1}";
  local file="${2}";
  debug "ensure \`$file'"
  if ! test "${arg}" "${file}"; then
    echo >&2 "error: Missing ${file}"
    exit 1
  fi
}

## run a spin process
spin-cmd () {
  local spin="${1}"; shift
  local cmd="${1}"; shift
  echo "${spin}: $cmd"
  ensure -f "${APP}/spins/${spin}/${cmd}"
  pushd . > /dev/null 2>&1
  cd "${APP}/spins/${spin}"
  ("${APP}/spins/${spin}/${cmd}" "${@}")
  local rc=$?
  popd > /dev/null 2>&1
  return ${rc}
}

## main function
spotlet () {
  local rc=0
  local spins=()

  ## setup state
  setup

  ## common lib
  source $(which spotlet-mount-common)

  cd ${APP}

  ## ensures dependencies structure exists
  ensure -d "${PREFIX}"
  ensure -d "${PREFIX}"
  ensure -d "${SPOTLET}"
  ensure -d "${SERVICE}"
  ensure -d "${APP}"

  chown -fR '0000:0000' ${APP}
  if test -d ${APP}/spins; then
    pushd . > /dev/null 2>&1
    cd ${TMPDIR:-/tmp}
    spins+=($( ls ${APP}/spins ))

    for spin in ${spins[@]}; do
      info "Building spin \`${spin}'"

      export SPIN_DIR="${spin}"

      ## feature detect and determine if
      ## compilation is needed
      (spin-cmd ${spin} 'detect')
      rc=$?
      if [ "${rc}" == "${ERROR}" ]; then
        return ${rc}
      elif [ "${rc}" == "${NEEDS_COMPILE}" ]; then
        info "Needs compile"
        (spin-cmd ${spin} 'compile')
        if [ "${rc}" == "${ERROR}" ]; then
          return ${rc}
        fi
      fi

      ## run tests
      (spin-cmd ${spin} 'test')
      rc=$?
      if [ "${rc}" == "${ERROR}" ]; then
        return ${rc}
      fi

      if (( ${rc} > 0 && ${rc} < 10 )); then
        return ${rc}
      fi
    done
    popd > /dev/null 2>&1
  fi

  ls $APP
  ## run
  if test -f "${APP}/start"; then
    info "Starting application..."
    {
      cd ${APP}
      mkdir -p ${SERVICE}/log
      #./start > ${SERVICE}/log/stdout 2> ${SERVICE}/log/stderr
      ./start
    }
  fi

  return $?
}

## run
(spotlet "${@}")
exit $?

